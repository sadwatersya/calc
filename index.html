<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Калькулятор шаблонов</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: Arial, sans-serif; 
            padding: 10px; 
            background: #f0f2f5;
            line-height: 1.4;
        }
        .container { 
            max-width: 100%; 
            background: white; 
            padding: 15px; 
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* Стили для вкладок */
        .tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 2px solid #e1e5e9;
            flex-wrap: wrap;
        }
        .tab {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            font-weight: 600;
            color: #5f6368;
            transition: all 0.3s;
            text-align: center;
            flex: 1;
            min-width: 100px;
            font-size: 14px;
        }
        .tab.active {
            border-bottom-color: #1a73e8;
            color: #1a73e8;
            background: #f8f9fa;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        .section { 
            padding: 0;
            border: none;
            background: transparent;
        }
        .input-group { 
            margin-bottom: 12px; 
        }
        label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: 600;
            color: #3c4043;
            font-size: 13px;
        }
        input { 
            width: 100%; 
            padding: 10px; 
            border: 2px solid #dadce0; 
            border-radius: 6px; 
            font-size: 14px;
            background: white;
        }
        input:focus {
            border-color: #1a73e8;
            outline: none;
            box-shadow: 0 0 0 2px rgba(26,115,232,0.2);
        }
        .distance-info {
            background: #e6f4ea;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
            /* Убрана border-left */
            font-size: 14px;
            line-height: 1.5;
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 0;
        }
        .distance-item {
            flex: 1;
            min-width: 0;
            text-align: center;
        }
        .distance-label {
            font-weight: 600;
            color: #1e8e3e;
            margin-bottom: 3px;
            font-size: 13px;
        }
        .distance-value {
            font-weight: 700;
            color: #0d652d;
            font-size: 15px;
        }
        .results-info {
            background: #e8f0fe;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            /* Убрана border-left */
            font-size: 14px;
            line-height: 1.4;
            white-space: pre-wrap;
            font-family: Arial, sans-serif;
        }
        .auto-field {
            background: #f0f7ff;
            border: 1px dashed #1a73e8;
        }
        .start-button {
            width: 100%; 
            padding: 12px; 
            background: #1a73e8; 
            color: white; 
            border: none; 
            border-radius: 6px; 
            font-size: 16px; 
            cursor: pointer;
            margin: 10px 0;
            font-weight: 600;
        }
        .start-button:hover {
            background: #1669d6;
        }
        .params-display {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #e1e5e9;
            font-size: 14px;
            line-height: 1.4;
        }
        
        /* Стили для модального окна ввода параметров */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal {
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal h3 {
            margin: 0 0 15px 0;
            color: #1a73e8;
            text-align: center;
        }
        .modal-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #dadce0;
            border-radius: 6px;
            font-size: 16px;
            margin-bottom: 15px;
            background: white;
        }
        .modal-input:focus {
            border-color: #1a73e8;
            outline: none;
            box-shadow: 0 0 0 2px rgba(26,115,232,0.2);
        }
        .modal-buttons {
            display: flex;
            gap: 10px;
        }
        .modal-button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 600;
        }
        .modal-button.primary {
            background: #1a73e8;
            color: white;
        }
        .modal-button.secondary {
            background: #f0f2f5;
            color: #5f6368;
        }
        .step-indicator {
            text-align: center;
            color: #5f6368;
            font-size: 12px;
            margin-bottom: 10px;
        }
        
        .version {
            text-align: center;
            color: #5f6368;
            font-size: 10px;
            margin-top: 15px;
        }

        /* Новые стили для расположения полей в ряд */
        .input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }
        .input-row .input-group {
            flex: 1;
            margin-bottom: 0;
        }

        /* Стили для двухколоночного отображения результатов */
        .two-column-results {
            display: flex;
            gap: 15px;
        }
        .results-column {
            flex: 1;
        }
        .results-column .results-info {
            margin: 0;
            height: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="tabs">
            <div class="tab active" onclick="showTab('difference')">Шаблон</div>
            <div class="tab" onclick="showTab('markup')">Разметка</div>
        </div>

        <!-- Вкладка ШАБЛОН -->
        <div id="difference" class="tab-content active">
            <div class="section">
                <button class="start-button" onclick="startParameterInput()">
                    ВВЕСТИ ПАРАМЕТРЫ
                </button>
                
                <div class="params-display" id="paramsDisplay">
                    Параметры не введены. Нажмите кнопку выше.
                </div>
                
                <div class="distance-info" id="distanceInfo">
                    <div class="distance-item">
                        <div class="distance-label">Расстояние:</div>
                        <div class="distance-value">-</div>
                    </div>
                    <div class="distance-item">
                        <div class="distance-label">Разница:</div>
                        <div class="distance-value">-</div>
                    </div>
                    <div class="distance-item">
                        <div class="distance-label">Угол:</div>
                        <div class="distance-value">-</div>
                    </div>
                </div>
                
                <div class="two-column-results" id="differenceResultsContainer">
                    <div class="results-column">
                        <div class="results-info" id="differenceResultsLeft">
                            Результаты появятся после ввода параметров
                        </div>
                    </div>
                    <div class="results-column">
                        <div class="results-info" id="differenceResultsRight">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Вкладка РАЗМЕТКА -->
        <div id="markup" class="tab-content">
            <div class="section">
                <div class="input-row">
                    <div class="input-group">
                        <label>Отверстий в шаблоне:</label>
                        <input type="number" id="holesInTemplate" value="11" step="1" inputmode="numeric" onfocus="this.select();">
                    </div>
                    <div class="input-group">
                        <label>Погрешность (мм):</label>
                        <input type="number" id="tolerance" value="10.0" step="0.1" inputmode="decimal" onfocus="this.select();">
                    </div>
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <label>Отверстий на ленте:</label>
                        <input type="number" id="holesOnTape" value="0" step="1" class="auto-field" readonly>
                    </div>
                    <div class="input-group">
                        <label>Проходов:</label>
                        <input type="number" id="passes" value="0" step="0.1" class="auto-field" readonly>
                    </div>
                </div>
                <div class="results-info" id="stepsResults">Введите количество отверстий в шаблоне</div>
                <div class="results-info" id="runResults">Введите погрешность</div>
            </div>
        </div>

        <div class="version">v15.7</div>
    </div>

    <!-- Модальное окно для ввода параметров -->
    <div class="modal-overlay" id="parameterModal">
        <div class="modal">
            <h3 id="modalTitle">Введите параметры</h3>
            <div class="step-indicator" id="stepIndicator">Шаг 1 из 4</div>
            <input type="number" 
                   id="modalInput" 
                   class="modal-input" 
                   inputmode="decimal"
                   step="0.1"
                   placeholder="Введите значение"
                   autofocus>
            <div class="modal-buttons">
                <button class="modal-button secondary" onclick="cancelParameterInput()">Отмена</button>
                <button class="modal-button primary" onclick="confirmParameterInput()">Далее</button>
            </div>
        </div>
    </div>

    <script>
        let calculatedDistance = 0;
        let userParams = {
            radius: 0,
            arc: 0,
            holesCount: 0,
            edge: 0
        };
        let calculationTimeout = null;
        let currentInputStep = 0;
        const inputSteps = [
            { title: "Введите внешний радиус (мм)", field: "radius", type: "decimal" },
            { title: "Введите внешнюю дугу (мм)", field: "arc", type: "decimal" },
            { title: "Введите количество отверстий", field: "holesCount", type: "numeric" },
            { title: "Введите отступ от края (мм)", field: "edge", type: "decimal" }
        ];

        // Функции для работы с localStorage
        function saveToStorage() {
            const data = {
                userParams: userParams,
                holesInTemplate: document.getElementById('holesInTemplate').value,
                tolerance: document.getElementById('tolerance').value,
                holesOnTape: document.getElementById('holesOnTape').value,
                passes: document.getElementById('passes').value,
                differenceResultsLeft: document.getElementById('differenceResultsLeft').textContent,
                differenceResultsRight: document.getElementById('differenceResultsRight').textContent,
                stepsResults: document.getElementById('stepsResults').textContent,
                runResults: document.getElementById('runResults').textContent,
                distanceValues: Array.from(document.querySelectorAll('.distance-value')).map(el => el.innerHTML)
            };
            localStorage.setItem('templateCalculatorData', JSON.stringify(data));
        }

        function loadFromStorage() {
            const saved = localStorage.getItem('templateCalculatorData');
            if (saved) {
                const data = JSON.parse(saved);
                
                // Восстанавливаем параметры
                if (data.userParams) {
                    userParams = data.userParams;
                    updateParamsDisplay();
                    document.getElementById('holesOnTape').value = userParams.holesCount || '0';
                }
                
                // Восстанавливаем поля ввода
                if (data.holesInTemplate) document.getElementById('holesInTemplate').value = data.holesInTemplate;
                if (data.tolerance) document.getElementById('tolerance').value = data.tolerance;
                if (data.holesOnTape) document.getElementById('holesOnTape').value = data.holesOnTape;
                if (data.passes) document.getElementById('passes').value = data.passes;
                
                // Восстанавливаем результаты
                if (data.differenceResultsLeft) document.getElementById('differenceResultsLeft').textContent = data.differenceResultsLeft;
                if (data.differenceResultsRight) document.getElementById('differenceResultsRight').textContent = data.differenceResultsRight;
                if (data.stepsResults) document.getElementById('stepsResults').textContent = data.stepsResults;
                if (data.runResults) document.getElementById('runResults').textContent = data.runResults;
                
                // Восстанавливаем значения в зеленом поле
                if (data.distanceValues && data.distanceValues.length === 3) {
                    document.querySelectorAll('.distance-value').forEach((el, index) => {
                        el.innerHTML = data.distanceValues[index];
                    });
                }
                
                // Пересчитываем все, если есть параметры
                if (userParams.radius && userParams.arc && userParams.holesCount && userParams.edge) {
                    calculateDifference();
                    calculateSteps();
                    calculateRun();
                }
            }
        }

        function clearStorage() {
            localStorage.removeItem('templateCalculatorData');
        }

        // Точное округление как в Python round()
        function preciseRound(num, decimals) {
            const factor = Math.pow(10, decimals);
            return Math.round(num * factor) / factor;
        }

        // Запуск ввода параметров через модальное окно
        function startParameterInput() {
            currentInputStep = 0;
            showInputStep();
        }

        // Показать текущий шаг ввода
        function showInputStep() {
            const step = inputSteps[currentInputStep];
            document.getElementById('modalTitle').textContent = step.title;
            document.getElementById('stepIndicator').textContent = `Шаг ${currentInputStep + 1} из ${inputSteps.length}`;
            document.getElementById('modalInput').value = '';
            
            // Настраиваем inputmode в зависимости от типа данных
            if (step.type === 'numeric') {
                document.getElementById('modalInput').inputMode = 'numeric';
                document.getElementById('modalInput').step = '1';
            } else {
                document.getElementById('modalInput').inputMode = 'decimal';
                document.getElementById('modalInput').step = '0.1';
            }
            
            document.getElementById('parameterModal').classList.add('active');
            
            // Фокус и выделение текста с небольшой задержкой для гарантии
            setTimeout(() => {
                const modalInput = document.getElementById('modalInput');
                modalInput.focus();
                modalInput.select();
            }, 100);
        }

        // Подтверждение ввода параметра
        function confirmParameterInput() {
            const input = document.getElementById('modalInput');
            const value = input.value.trim();
            const step = inputSteps[currentInputStep];
            
            if (!value) {
                alert('Пожалуйста, введите значение');
                input.focus();
                input.select();
                return;
            }
            
            let numericValue;
            if (step.type === 'numeric') {
                numericValue = parseInt(value);
                if (isNaN(numericValue) || numericValue <= 0) {
                    alert('Пожалуйста, введите корректное целое число');
                    input.focus();
                    input.select();
                    return;
                }
            } else {
                numericValue = parseFloat(value);
                if (isNaN(numericValue) || numericValue <= 0) {
                    alert('Пожалуйста, введите корректное число');
                    input.focus();
                    input.select();
                    return;
                }
            }
            
            // Сохраняем значение
            userParams[step.field] = numericValue;
            
            // Переходим к следующему шагу или завершаем
            currentInputStep++;
            if (currentInputStep < inputSteps.length) {
                showInputStep();
            } else {
                // Все параметры введены
                document.getElementById('parameterModal').classList.remove('active');
                completeParameterInput();
            }
            
            saveToStorage();
        }

        // Отмена ввода параметров
        function cancelParameterInput() {
            document.getElementById('parameterModal').classList.remove('active');
            currentInputStep = 0;
        }

        // Завершение ввода параметров
        function completeParameterInput() {
            // Обновляем отображение параметров
            updateParamsDisplay();
            
            // Обновляем поле в шагах
            document.getElementById('holesOnTape').value = userParams.holesCount;
            
            // Выполняем расчет
            calculateDifference();
            calculateSteps();
            
            saveToStorage();
        }

        // Обновление отображения введенных параметров
        function updateParamsDisplay() {
            const display = document.getElementById('paramsDisplay');
            if (userParams.radius && userParams.arc && userParams.holesCount && userParams.edge) {
                display.innerHTML = `
                    • Внешний радиус: <strong>${userParams.radius}</strong> мм<br>
                    • Внешняя дуга: <strong>${userParams.arc}</strong> мм<br>
                    • Количество отверстий: <strong>${userParams.holesCount}</strong><br>
                    • Отступ от края: <strong>${userParams.edge}</strong> мм
                `;
            } else {
                display.innerHTML = 'Параметры не введены. Нажмите кнопку выше.';
            }
        }

        // Переключение вкладок
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`.tab[onclick="showTab('${tabName}')"]`).classList.add('active');
            
            saveToStorage();
        }

        // Расчет расстояния между креплениями
        function calculateDistanceBetweenHoles() {
            if (!userParams.radius || !userParams.arc || !userParams.holesCount || !userParams.edge) {
                document.querySelectorAll('.distance-value').forEach(el => el.textContent = '-');
                return 0;
            }
            
            // Расчет расстояния с учетом отступа
            const distanceOnOuterEdge = userParams.arc / userParams.holesCount;
            const effectiveRadius = userParams.radius - userParams.edge;
            if (effectiveRadius <= 0) {
                document.querySelectorAll('.distance-value').forEach(el => el.textContent = 'Ошибка');
                return 0;
            }
            
            const reductionFactor = effectiveRadius / userParams.radius;
            calculatedDistance = distanceOnOuterEdge * reductionFactor;
            
            return calculatedDistance;
        }

        // Функция ШАБЛОН
        function calculateDifference() {
            if (!userParams.radius || !userParams.arc || !userParams.holesCount && !userParams.edge) {
                document.getElementById('differenceResultsLeft').textContent = 'Введите параметры для расчета';
                document.getElementById('differenceResultsRight').textContent = '';
                document.querySelectorAll('.distance-value').forEach(el => el.textContent = '-');
                return;
            }
            
            // Расчет расстояния
            const distance = calculateDistanceBetweenHoles();
            
            // Расчет разницы дуги
            const variants = [
                userParams.radius * 2 * Math.PI,
                userParams.radius * Math.PI,
                userParams.radius * Math.PI / 2,
                userParams.radius * 2 * Math.PI / 3,
                userParams.radius * 2 * Math.PI / 6
            ];
            
            const closest = variants.reduce((prev, curr) => 
                Math.abs(curr - userParams.arc) < Math.abs(prev - userParams.arc) ? curr : prev
            );
            const difference = userParams.arc - closest;
            const angle = (userParams.arc * (180 / Math.PI)) / userParams.radius;
            
            // Обновляем информацию в зеленом поле
            document.querySelectorAll('.distance-value')[0].innerHTML = `<strong>${preciseRound(distance, 1)} мм</strong>`;
            document.querySelectorAll('.distance-value')[1].innerHTML = `<strong>${Math.round(difference)} мм</strong>`;
            document.querySelectorAll('.distance-value')[2].innerHTML = `<strong>${Math.round(angle)}°</strong>`;
            
            // Расчет шаблона с ограничением до ~1300 и максимум 50 итераций
            let templateResults = [];
            const TARGET_VALUE = 1300; // Целевое значение
            const MAX_ITERATIONS = 50; // Максимум 50 итераций для защиты
            
            let i = 1;
            while (i <= MAX_ITERATIONS) {
                const currentArc = calculatedDistance * i;
                const effectiveRadius = userParams.radius - userParams.edge;
                
                if (effectiveRadius <= 0) {
                    document.getElementById('differenceResultsLeft').textContent = 'Ошибка: радиус должен быть больше отступа';
                    document.getElementById('differenceResultsRight').textContent = '';
                    return;
                }
                
                const templateAngle = currentArc / effectiveRadius / 2;
                const result = 2 * effectiveRadius * Math.sin(templateAngle);
                const roundedResult = preciseRound(result, 1);
                
                // Добавляем результат
                templateResults.push({ index: i, value: roundedResult });
                
                // Проверяем, достигли ли целевого значения
                if (roundedResult >= TARGET_VALUE) {
                    break;
                }
                
                i++;
            }
            
            // Разделяем результаты на две колонки
            const middleIndex = Math.ceil(templateResults.length / 2);
            const leftColumnResults = templateResults.slice(0, middleIndex);
            const rightColumnResults = templateResults.slice(middleIndex);
            
            // Формируем левую колонку
            let leftResults = '';
            leftColumnResults.forEach(item => {
                leftResults += item.index + '. ' + item.value + '\n';
            });
            
            // Формируем правую колонку
            let rightResults = '';
            rightColumnResults.forEach(item => {
                rightResults += item.index + '. ' + item.value + '\n';
            });
            
            document.getElementById('differenceResultsLeft').textContent = leftResults;
            document.getElementById('differenceResultsRight').textContent = rightResults;
            
            saveToStorage();
        }

        // Функция ШАГИ
        function calculateSteps() {
            // Очищаем предыдущий таймер
            if (calculationTimeout) {
                clearTimeout(calculationTimeout);
            }
            
            // Ставим новый таймер с задержкой для мобильных
            calculationTimeout = setTimeout(() => {
                const holesOnTape = parseInt(document.getElementById('holesOnTape').value);
                const holesInTemplate = parseInt(document.getElementById('holesInTemplate').value);
                
                // Проверяем только holesInTemplate
                if (!holesInTemplate || holesInTemplate <= 0) {
                    document.getElementById('stepsResults').textContent = 'Введите количество отверстий в шаблоне';
                    document.getElementById('passes').value = '0';
                    return;
                }
                
                if (!holesOnTape || holesOnTape <= 0) {
                    document.getElementById('stepsResults').textContent = 'Сначала введите параметры в разделе "Шаблон"';
                    document.getElementById('passes').value = '0';
                    return;
                }
                
                const steps = [];
                let currentValue = holesInTemplate;
                
                // Безопасный расчет шагов с ограничением
                let iterationCount = 0;
                const maxIterations = 1000; // Защита от бесконечного цикла
                
                while (currentValue <= holesOnTape && iterationCount < maxIterations) {
                    steps.push(currentValue.toString());
                    currentValue += (holesInTemplate - 1);
                    iterationCount++;
                }
                
                if (iterationCount >= maxIterations) {
                    document.getElementById('stepsResults').textContent = 'Слишком большое количество итераций';
                    return;
                }
                
                const ratio = (holesOnTape / (holesInTemplate - 1)).toFixed(1);
                steps.push('(' + ratio + ')');
                
                // Обновляем поле проходов в разгоне
                document.getElementById('passes').value = ratio;
                
                document.getElementById('stepsResults').textContent = steps.join('  ');
                
                // Пересчитываем разгон
                calculateRun();
                
                saveToStorage();
            }, 100);
        }

        // Функция РАЗГОН
        function calculateRun() {
            const tolerance = parseFloat(document.getElementById('tolerance').value);
            const passes = parseFloat(document.getElementById('passes').value);
            
            if (!tolerance || tolerance <= 0 || !passes || passes <= 0) {
                document.getElementById('runResults').textContent = 'Введите погрешность и убедитесь, что проходы рассчитаны';
                return;
            }
            
            const step = tolerance / passes;
            let results = '';
            
            const values = [];
            for (let i = 1; i <= passes; i++) {
                const value = step * i;
                // Используем точное округление для разгона
                values.push(preciseRound(value, 1));
            }
            
            results += values.join('   ');
            document.getElementById('runResults').textContent = results;
            
            saveToStorage();
        }

        // Обработчик ввода для мобильных устройств
        function handleMobileInput(event) {
            if (event.target.id === 'holesInTemplate' || event.target.id === 'tolerance') {
                // Очищаем предыдущий таймер
                if (calculationTimeout) {
                    clearTimeout(calculationTimeout);
                }
                
                // Запускаем расчет с задержкой
                calculationTimeout = setTimeout(() => {
                    if (event.target.id === 'holesInTemplate') {
                        calculateSteps();
                    } else if (event.target.id === 'tolerance') {
                        calculateRun();
                    }
                    saveToStorage();
                }, 500);
            }
        }

        // Инициализация при загрузке
        window.onload = function() {
            // Загружаем сохраненные данные
            loadFromStorage();
            
            // Устанавливаем начальные значения, если нет сохраненных
            if (!localStorage.getItem('templateCalculatorData')) {
                document.getElementById('holesOnTape').value = '0';
                document.getElementById('passes').value = '0';
            }
            
            // Используем input событие вместо change для лучшей поддержки мобильных
            document.getElementById('holesInTemplate').addEventListener('input', handleMobileInput);
            document.getElementById('tolerance').addEventListener('input', handleMobileInput);
            
            // Обработчик Enter в модальном окне
            document.getElementById('modalInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    confirmParameterInput();
                }
            });
            
            // Сохраняем при закрытии страницы
            window.addEventListener('beforeunload', saveToStorage);
        };
    </script>
</body>
</html>
